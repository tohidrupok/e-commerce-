{% extends "base.html" %}
{% load static %}

{% block title %}{{ product.name }}{% endblock %}

{% block content %}
<div class="main-container container">
    <ul class="breadcrumb">
        <li><a href="{% url 'home' %}"><i class="fa fa-home"></i></a></li>
        <li><a href="#">{{ product.category.name }}</a></li>
        <li><a href="#">{{ product.name }}</a></li>
    </ul>

    <div class="row">
        <!--Middle Part Start-->
        <div id="content" class="col-md-12 col-sm-12">
            <div class="product-view row">
    <div class="left-content-product col-lg-12 col-xs-12">
        <div class="row">
            <!-- Left Column -->
<!-- Left Column -->
<div class="content-product-left col-sm-4 col-xs-12">

    {% with first_img=product.images.all|first %}
    {% if first_img %}
    <div class="large-image">

        <!-- Popup/zoom link -->
        <a id="mainImageLink" href="{{ first_img.image.url }}" data-lightbox="product-gallery">
            <img id="mainProductImage"
                 src="{{ first_img.image.url }}"
                 alt="{{ first_img.alt_text|default:product.name }}">
        </a>

    </div>
    {% endif %}
    {% endwith %}

    <div class="thumb-row">
        {% for img in product.images.all %}
        <a class="thumbnail {% if forloop.first %}active{% endif %}"
           data-image="{{ img.image.url }}">
            <img src="{{ img.image.url }}" alt="">
        </a>
        {% endfor %}
    </div>

</div>


<!-- JS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
$(document).ready(function() {

    // Thumbnail click event
    $('.thumb-row .thumbnail').on('click', function(e) {
        e.preventDefault();

        const newImage = $(this).attr('data-image');

        // Remove active from all thumbnails
        $('.thumb-row .thumbnail').removeClass('active');
        $(this).addClass('active');

        // Fade effect when updating main image
        $('#mainProductImage').fadeOut(150, function() {
            $(this).attr('src', newImage).fadeIn(150);
        });
    });

    // Disable hover image switching
    $('.thumb-row .thumbnail').off('mouseenter mouseleave');
});
</script>

<!-- CSS -->
<style>
body, .product-view {
    font-family: 'Roboto', sans-serif;
    color: #222;
}

/* Main Image */
.large-image img {
    width: 100%;
    height: 350px;
    object-fit: contain;
    border-radius: 6px;
    margin-bottom: 10px;
}

/* Thumbnail Row */
.thumb-row {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

/* Each Thumbnail Image */
.thumb-row .thumbnail img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.3s ease;
}

/* Active or Hover Thumbnail */
.thumb-row .thumbnail.active img,
.thumb-row .thumbnail:hover img {
    border-color: #ff6600;
}

/* Right Column */
.content-product-right {
    font-family: 'Roboto', sans-serif;
    color: #222;
}

.content-product-right h1 {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 10px;
}

.content-product-right .price-new {
    font-size: 22px;
    color: #ff6600;
    font-weight: 700;
}

.content-product-right .price-old {
    font-size: 16px;
    color: #999;
    text-decoration: line-through;
    margin-left: 5px;
}
</style>



<!-- Right Column -->
<div class="content-product-right col-sm-8 col-xs-12">
    <style>
        .product-tags span {
            display: inline-block;
            background: #f3f4f6;
            padding: 6px 14px;
            margin-right: 6px;
            border-radius: 20px;
            font-size: 14px;
            color: #333;
        }
        
        .product-tags span strong {
            font-weight: 600;
        }
        
        .key-features {
            margin-top: 25px;
            font-size: 16px;
            font-family: 'Roboto', sans-serif;
        }
        
        .payment-box {
            border: 2px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            min-height: 50px;
            cursor: pointer;
            width:40%;
        }
        
        .payment-box.active {
            border-color: #2d4ed8;
        }
        
        .payment-box input {
            transform: scale(1.3);
        }
        
        .buy-btn {
            background: #2d3ecf;
            color: #fff;
            font-size: 18px;
            padding: 14px 30px;
            border-radius: 8px;
            border: none;
        }
        
        .qty-box {
            border: 1px solid #ddd;
            padding: 8px 18px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            width: fit-content;
        }
        
        .qty-box span {
            cursor: pointer;
            font-size: 20px;
            padding: 0 10px;
        }
        
        .qty-box input {
            width: 50px;
            text-align: center;
            font-size: 16px;
            border: none;
        }
        
        </style>
        <h1 style="font-family: 'Roboto', sans-serif !important;" class="text-3xl font-semibold text-blue-900 mb-4">
            {{ product.name }}
        </h1>
        
        <!-- TAGS -->
        <div class="product-tags mb-5">
        
            <span>
                Price:
                <strong>{{ product.price }}৳</strong>
                {% if product.old_price %}
                    <del style="margin-left:5px; color:#888;">{{ product.old_price }}৳</del>
                {% endif %}
            </span>
        
            <span>
                Regular Price:
                <strong>{{ product.old_price|default:product.price }}৳</strong>
            </span>
        
            <span>
                Status:
                {% if product.stock_quantity > 0 %}
                    <strong style="color:#15803d;">In Stock</strong>
                {% else %}
                    <strong style="color:#dc2626;">Out of Stock</strong>
                {% endif %}
            </span>
        
            <span>
                Product Code:
                <strong>{{ product.id }}</strong>
            </span>
        
            <span>
                Brand:
                <strong>{{ product.brand.name }}</strong>
            </span>
        
        </div>
        
        
        <!-- KEY FEATURES -->
        <h2 class="text-xl font-semibold mb-2">Key Features</h2>
        
        <div class="key-features">
            {{ product.short_description|linebreaks }}
        </div>
        
        <a href="#more" class="text-red-600 font-semibold mt-2 inline-block">View More Info</a>
        
        
        <!-- PAYMENT OPTIONS -->
        <h2 class="text-xl font-semibold mt-6 mb-3">Payment Options</h2>
        
        <div style="display:flex; gap:20px; flex-wrap:wrap;">
        
            <!-- Cash Price -->
            <label class="payment-box active" id="cashBox">
                <div style="display:flex; gap:16px;">
                    <input type="radio" name="pay" checked>
                    <div>
                        <div style="font-size:16px; font-weight:bold;">{{ product.price }}৳</div>
                        {% if product.old_price %}
                        <div style="color:#999; text-decoration:line-through;">{{ product.old_price }}৳</div>
                        {% endif %}
                        <div style="margin-top:5px;">Cash Discount Price</div>
                        <div style="color:#888; font-size:14px;">Online / Cash Payment</div>
                    </div>
                </div>
            </label>
        
            <!-- EMI -->
            <label class="payment-box" id="emiBox">
                <div style="display:flex; gap:16px;">
                    <input type="radio" name="pay">
                    <div>
                        <div style="font-size:16px; font-weight:bold;">913৳/month</div>
                        <div style="font-size:12px;">Regular Price: {{ product.old_price|default:product.price }}৳</div>
                        <div style="margin-top:5px; color:#777; font-size:14px;">
                            0% EMI for up to 12 Months
                        </div>
                    </div>
                </div>
            </label>
        
        </div>
        
        
        <!-- QTY + BUY BUTTON -->
        <div style="margin-top:30px; display:flex; gap:25px;">
        
            <!-- Qty -->
            <div class="qty-box">
                <span onclick="qtyDown()">−</span>
                <input type="text" id="qty" value="1">
                <span onclick="qtyUp()">+</span>
            </div>
        
            

            <!-- <button class="buy-btn" onclick="addToCart('{{ product.id }}', document.getElementById('qty').value)">
                Buy Now
            </button> -->

            <button class="buy-btn" onclick="addToCart('{{ product.id }}')">
                Buy Now
            </button> 

        
        </div>

        <!-- ADD TO CART POPUP -->
        <div id="cartPopup" style="
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 350px; background: white; padding: 20px;
            border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.3);
            display: none; z-index: 9999; text-align: center;
        ">
            <h3 style="font-size:20px; color:#10b981;">✔ Added to Cart</h3>
            <p id="cartMsg" style="margin-top:10px;"></p>
            <div style="margin-top:20px; display:flex; justify-content:center; gap:10px;">
                <a href="/cart/" 
                style="background:#2563eb; color:#fff; padding:10px 18px; border-radius:6px; font-weight:600;">
                Go to Cart
                </a>
                <button onclick="closeCartPopup()" 
                        style="background:#6b7280; color:#fff; padding:10px 18px; border-radius:6px; font-weight:600;">
                    Continue
                </button>
            </div>
        </div>

        <!-- BACKDROP -->
        <div id="cartBackdrop" style="
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5); z-index: 9998; display:none;">
        </div>

        <script>
        function closeCartPopup() {
            document.getElementById("cartPopup").style.display = "none";
            document.getElementById("cartBackdrop").style.display = "none";
        }

        // ADD TO CART with AJAX & proper popup
        function addToCart(productId) {
            let qty = document.getElementById("qty").value;

            fetch(`/add-to-cart/${productId}/?qty=${qty}`)
            .then(res => res.json())
            .then(data => {
                // Show popup message
                document.getElementById("cartMsg").innerHTML =
                    `Product <b>${data.product_name}</b> Added Successfully<br>
                    Quantity: <b>${qty}</b><br>
                    Cart Qty: <b>${data.cart_qty}</b>, Total: <b>${data.cart_total}</b>`;

                document.getElementById("cartPopup").style.display = "block";
                document.getElementById("cartBackdrop").style.display = "block";

                // Update floating cart badge if exists
                let badge = document.getElementById("cartBadge");
                if(badge){
                    badge.innerText = data.cart_qty;
                    badge.style.transform = "scale(1.4)";
                    setTimeout(()=> badge.style.transform="scale(1)",300);
                }

                // Optionally auto hide after 4s
                setTimeout(closeCartPopup,4000);
            })
            .catch(err => console.error("Add to cart error:", err));
        }

        // Quantity buttons
        function qtyUp() {
            let q = document.getElementById("qty");
            q.value = parseInt(q.value)+1;
        }

        function qtyDown() {
            let q = document.getElementById("qty");
            if(parseInt(q.value)>1) q.value--;
        }
        </script>

                
                <br/>
        </div>




            <!-- Product Tabs -->
            <div class="producttab">
                <div class="tabsslider col-xs-12">
                    <ul class="nav nav-tabs">
                        <li class="active"><a data-toggle="tab" href="#tab-1">Description</a></li>
                        <li class="item_nonactive"><a data-toggle="tab" href="#tab-review">Reviews ({{ product.reviews.count }})</a></li>
                        <li class="item_nonactive"><a data-toggle="tab" href="#tab-4">Tags</a></li>
                        <li class="item_nonactive"><a data-toggle="tab" href="#tab-5">Custom Tab</a></li>
                    </ul>

                    <div class="tab-content col-xs-12">
                        <!-- Description -->
                        <div id="tab-1" class="tab-pane fade active in">
                            {{ product.description|linebreaks }}
                        </div>
                        
                        <div class="product-specifications">
                            {{ product.specifications|safe }}
                        </div> 

                        <!-- Reviews -->
                        <div id="tab-review" class="tab-pane fade">
                            {% for review in product.reviews.all %}
                            <div class="review-item">
                                <strong>{{ review.user.get_full_name|default:review.user.username }}</strong> - {{ review.created_at|date:"d/m/Y" }}
                                <p>{{ review.text }}</p>
                            </div>
                            {% empty %}
                            <p>No reviews yet.</p>
                            {% endfor %}

                            <h2>Write a review</h2>
                            <form method="post" action="">
                                {% csrf_token %}
                                <div class="form-group">
                                    <input type="text" name="name" class="form-control" placeholder="Your Name">
                                </div>
                                <div class="form-group">
                                    <textarea name="text" class="form-control" placeholder="Your Review"></textarea>
                                </div>
                                <div class="form-group">
                                    <b>Rating</b>
                                    {% for i in "12345" %}
                                        <input type="radio" name="rating" value="{{ forloop.counter }}"> 
                                    {% endfor %}
                                </div>
                                <button type="submit" class="btn btn-primary">Submit</button>
                            </form>
                        </div>

                        <!-- Tags -->
                        <div id="tab-4" class="tab-pane fade">
                            {% for tag in product.tags.all %}
                                <a href="#">{{ tag.name }}</a>{% if not forloop.last %}, {% endif %}
                            {% empty %}
                                <p>No tags.</p>
                            {% endfor %}
                        </div>

                        <!-- Custom Tab -->
                        <div id="tab-5" class="tab-pane fade">
                            <table class="data-table" style="width: 100%;" border="1">
                                <tbody>
                                    <tr>
                                        <td>Brand</td>
                                        <td>
                                            {% if product.brand.logo %}
                                                <img src="{{ product.brand.logo.url }}" alt="{{ product.brand.name }}">
                                            {% else %}
                                                {{ product.brand.name }}
                                            {% endif %}
                                        </td>
                                    </tr>

                                    <tr>
                                        <td>History</td>
                                        <td>{{ product.brand.history|linebreaks }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Related/Upsell Products -->
            <div class="related upsell titleLine products-list grid module">
                <h3 class="modtitle"><span>Upsell Products</span></h3>
                <div class="upsell-products">
                    {% for related in product.related_products.all %}
                    <div class="product-layout">
                        <div class="product-item-container">
                            <div class="left-block">
                                <div class="product-image-container second_img">
                                    <img src="{{ related.image_main.url }}" class="img-1 img-responsive">
                                    {% if related.images.all %}
                                        <img src="{{ related.images.first.image.url }}" class="img-2 img-responsive">
                                    {% endif %}
                                </div>
                                {% if related.old_price %}
                                <span class="label label-sale">Sale</span>
                                {% endif %}
                            </div>
                            <div class="button-group">
                                <button class="wishlist btn-button" type="button" onclick="wishlist.add('{{ related.id }}');"><i class="fa fa-heart"></i></button>
                                <button class="addToCart" type="button" onclick="cart.add('{{ related.id }}', '1');"><i class="fa fa-shopping-cart"></i></button>
                                <button class="compare" type="button" onclick="compare.add('{{ related.id }}');"><i class="fa fa-exchange"></i></button>
                                <a class="quickview iframe-link visible-lg btn-button" href="{% url 'product_quickview' related.id %}"><i class="fa fa-search"></i></a>
                            </div>
                            <div class="right-block">
                                <div class="caption">
                                    <h4><a href="{% url 'product_detail' related.id %}">{{ related.name }}</a></h4>
                                    <div class="ratings">
                                        <div class="rating-box">
                                            {% for i in "12345" %}
                                                {% if forloop.counter <= related.average_rating|default:0 %}
                                                    <span class="fa fa-stack"><i class="fa fa-star fa-stack-1x"></i></span>
                                                {% else %}
                                                    <span class="fa fa-stack"><i class="fa fa-star-o fa-stack-1x"></i></span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="price">
                                        <span class="price-new">${{ related.price }}</span>
                                        {% if related.old_price %}
                                            <span class="price-old">${{ related.old_price }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

        </div>
    </div>
</div>

{% endblock %}
